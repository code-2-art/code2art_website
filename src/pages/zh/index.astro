---
import BaseLayout from '../../layouts/BaseLayout.astro';
import { getCollection } from 'astro:content';
import { t, getLocalePath } from '../../i18n/ui';
import type { Lang } from '../../i18n/ui';

const lang: Lang = 'zh';

const allPosts = await getCollection('tutorials', ({ filePath }) => filePath.includes('/zh/'));
allPosts.sort((a, b) => new Date(b.data.publishedAt ?? 0).getTime() - new Date(a.data.publishedAt ?? 0).getTime());
const blogPosts = allPosts.slice(0, 6);

const allActivities = await getCollection('events', ({ filePath }) => filePath.includes('/zh/'));
allActivities.sort((a, b) => new Date(b.data.event_date ?? 0).getTime() - new Date(a.data.event_date ?? 0).getTime());
const activities = allActivities.slice(0, 6);
const formatEventDate = (value?: string | Date) => {
  if (!value) return '';
  const date = value instanceof Date ? value : new Date(value);
  return Number.isNaN(date.getTime()) ? '' : date.toISOString().slice(0, 10);
};

const otherLang = 'en';
const switchLabel = 'EN';
const switchHref = getLocalePath(otherLang, '/');
---

<BaseLayout title="ÂÆûÈ™åÁºñÁ®ã Experimental Programming" description="ÂÆûÈ™åÁºñÁ®ã Experimental Programming, Áî®ÂÆûÈ™åÁ≤æÁ•ûÂíåËÆ°ÁÆóÁºñÁ®ãËøõË°åËâ∫ÊúØÂàõ‰Ωú" lang={lang} altPath="">
  <!-- Navbar -->
  <header id="navbar" class="fixed w-full z-50 transition-all duration-300">
    <nav class="container mx-auto px-4 sm:px-6 lg:px-8 py-4 flex justify-between items-center">
      <a href="#home" class="flex items-center space-x-2">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-primary to-secondary flex items-center justify-center">
          <img src="https://float.intplusplus.cn/code2art/favicon.jpg" alt={t(lang, 'nav.brand') as string} class="w-10 h-10 rounded-lg" />
        </div>
        <span class="text-xl font-bold">{t(lang, 'nav.brand')}</span>
      </a>
      <div class="hidden md:flex items-center space-x-8">
        <a href="#home" class="font-medium hover:text-primary transition-colors">{t(lang, 'nav.about')}</a>
        <a href="#events" class="font-medium hover:text-primary transition-colors">{t(lang, 'nav.activities')}</a>
        <a href="#tutorials" class="font-medium hover:text-primary transition-colors">{t(lang, 'nav.blog')}</a>
        <a href="#contact" class="bg-gradient-to-r from-primary to-secondary text-white px-5 py-2 rounded-full font-medium hover:shadow-lg hover:shadow-primary/20 transition-all">{t(lang, 'nav.contact')}</a>
        <a href={switchHref} data-lang-switch={otherLang} class="font-medium hover:text-primary transition-colors border border-gray-300 px-3 py-1 rounded-full text-sm">{switchLabel}</a>
      </div>
      <button id="menu-toggle" class="md:hidden text-2xl" aria-label={t(lang, 'nav.menuLabel') as string}>‚ò∞</button>
    </nav>

    <!-- Mobile menu -->
    <div id="mobile-menu" class="md:hidden hidden bg-white shadow-lg border-t">
      <div class="container mx-auto px-4 py-4 flex flex-col">
        <a href="#home" class="py-3 font-medium hover:text-primary">{t(lang, 'nav.about')}</a>
        <a href="#events" class="py-3 font-medium hover:text-primary">{t(lang, 'nav.activities')}</a>
        <a href="#tutorials" class="py-3 font-medium hover:text-primary">{t(lang, 'nav.blog')}</a>
        <a href="#contact" class="mt-2 bg-gradient-to-r from-primary to-secondary text-white px-5 py-3 rounded-full font-medium text-center hover:shadow-lg hover:shadow-primary/20">{t(lang, 'nav.contact')}</a>
        <a href={switchHref} data-lang-switch={otherLang} class="mt-2 py-3 font-medium hover:text-primary text-center border border-gray-300 rounded-full text-sm">{switchLabel}</a>
      </div>
    </div>

    <script is:client>
      const navbar = document.getElementById('navbar');
      const toggle = document.getElementById('menu-toggle');
      const menu = document.getElementById('mobile-menu');
      function onScroll(){
        if (window.scrollY > 10) {
          navbar?.classList.add('bg-white/80','backdrop-blur','shadow');
        } else {
          navbar?.classList.remove('bg-white/80','backdrop-blur','shadow');
        }
      }
      onScroll();
      window.addEventListener('scroll', onScroll);
      toggle?.addEventListener('click', () => menu?.classList.toggle('hidden'));
      document.querySelectorAll('#mobile-menu a').forEach(a=>{
        a.addEventListener('click', ()=> menu?.classList.add('hidden'));
      });
      const langLinks = document.querySelectorAll('a[data-lang-switch]');
      langLinks.forEach((link) => {
        link.addEventListener('click', () => {
          const target = link.getAttribute('data-lang-switch');
          if (!target) return;
          document.cookie = `site_lang=${target}; Path=/; Max-Age=15552000; SameSite=Lax`;
        });
      });
    </script>
  </header>

  <!-- Hero Section -->
  <section id="home" class="pt-32 pb-20 md:pt-40 md:pb-32 overflow-hidden">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8 grid grid-cols-1 lg:grid-cols-2 gap-12 items-center">
      <div>
        <h1 class="text-[clamp(2.5rem,5vw,4rem)] font-bold leading-tight mb-6">
          {t(lang, 'hero.title.prefix')}
          <span class="bg-gradient-to-r from-primary to-secondary text-gradient">{t(lang, 'hero.title.highlight')}</span>
        </h1>
        <p class="text-lg md:text-xl text-gray-600 mb-8 max-w-xl">
          {t(lang, 'hero.description')}
          <br/>
          {t(lang, 'hero.description2')}
          <br/>
          <br/>
          {t(lang, 'hero.description.en')}
        </p>
        <div class="flex flex-col sm:flex-row gap-4">
          <a href="#contact" class="bg-gradient-to-r from-primary to-secondary text-white px-8 py-4 rounded-full font-medium text-center hover:shadow-lg hover:shadow-primary/20 transition-all transform hover:-translate-y-1">{t(lang, 'hero.joinCta')}</a>
          <a href="https://mp.weixin.qq.com/s/3z-tmlSkV0mlTrWAPXgoUw" class="border-2 border-primary text-primary px-8 py-4 rounded-full font-medium text-center hover:bg-primary/5 transition-all transform hover:-translate-y-1">{t(lang, 'hero.learnMore')}</a>
        </div>
      </div>
      <div class="relative">
        <div class="absolute inset-0 bg-gradient-to-r from-primary/20 to-secondary/20 rounded-3xl transform rotate-3 scale-95"
        style="background-image: url('https://float.intplusplus.cn/code2art/assets/fluid2.jpg'); background-size: cover; background-position: center;"
        >
        </div>

        <img src="https://float.intplusplus.cn/code2art/assets/fluid.jpg" width="600" height="600" alt={t(lang, 'hero.imgAlt') as string} class="relative z-10 rounded-3xl shadow-xl animate-float" />
      </div>
    </div>
  </section>

  <!-- Activities Section -->
  <section id="events" class="py-20 md:py-32">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center max-w-3xl mx-auto mb-16">
        <span class="text-primary font-semibold">{t(lang, 'activities.label')}</span>
        <h2 class="text-[clamp(1.8rem,3vw,2.5rem)] font-bold mt-2 mb-6">{t(lang, 'activities.heading')}</h2>
        <p class="text-gray-600 text-lg">{t(lang, 'activities.subheading')}</p>
      </div>

      {activities.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {activities.map((a) => (
            <div class="rounded-2xl overflow-hidden shadow-lg group hover:shadow-xl transition-all duration-300">
              <div class="relative">
                {a.data.coverUrl ? (
                  <a href={getLocalePath(lang, `/events/${a.data.slug}`)}>
                    <img src={a.data.coverUrl} alt={a.data.title} class="w-full h-60 object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy" />
                  </a>
                ) : (
                  <div class="w-full h-60 bg-gradient-to-br from-primary/10 to-secondary/10" />
                )}
                <div class="absolute top-4 left-4 bg-primary text-white px-3 py-1 rounded-full text-sm font-medium">{t(lang, 'activities.badge')}</div>
              </div>
              <div class="p-6">
                <div class="flex items-center text-gray-500 mb-3">üìÖ<span class="ml-2">{formatEventDate(a.data.event_date)}</span></div>
                <h3 class="text-xl font-bold mb-3 group-hover:text-primary transition-colors">
                  <a href={getLocalePath(lang, `/events/${a.data.slug}`)}>{a.data.title}</a>
                </h3>
              </div>
            </div>
          ))}
        </div>
      ) : (
        <div class="text-center text-slate-500">{t(lang, 'activities.empty')}</div>
      )}
    </div>
  </section>

  <!-- Blog Section -->
  <section id="tutorials" class="py-20 md:py-32 bg-gray-50">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="text-center max-w-3xl mx-auto mb-16">
        <span class="text-primary font-semibold">{t(lang, 'blog.label')}</span>
        <h2 class="text-[clamp(1.8rem,3vw,2.5rem)] font-bold mt-2 mb-6">{t(lang, 'blog.heading')}</h2>
        <p class="text-gray-600 text-lg">{t(lang, 'blog.subheading')}</p>
      </div>

      {blogPosts.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {blogPosts.map((post) => (
            <article class="bg-white rounded-2xl overflow-hidden shadow-md hover:shadow-xl transition-all duration-300 group">
              <div class="relative">
                {post.data.coverUrl ? (
                  <a href={getLocalePath(lang, `/tutorials/${post.data.slug}`)}>
                    <img src={post.data.coverUrl} alt={post.data.title} class="w-full h-60 object-cover group-hover:scale-105 transition-transform duration-500" loading="lazy" />
                  </a>
                ) : (
                  <div class="w-full h-60 bg-gradient-to-br from-primary/10 to-secondary/10" />
                )}
              </div>
              <div class="p-6">
                <div class="flex items-center mb-4">
                  <div class="flex flex-wrap gap-2">
                    {(post.data.tags ?? []).slice(0,4).map((tg) => (
                      <span class="bg-blue-100 text-blue-800 text-xs px-3 py-1 rounded-full">{tg}</span>
                    ))}
                  </div>
                  <span class="ml-auto text-gray-500 text-sm">{post.data.publishedAt?.slice(0,10)}</span>
                </div>
                <h3 class="text-xl font-bold mb-3 hover:text-primary transition-colors">
                  <a href={getLocalePath(lang, `/tutorials/${post.data.slug}`)}>{post.data.title}</a>
                </h3>
                {post.data.summary && <p class="text-gray-600 mb-4 line-clamp-3">{post.data.summary}</p>}
              </div>
            </article>
          ))}
        </div>
      ) : (
        <div class="text-center text-slate-500">{t(lang, 'blog.empty')}</div>
      )}

      <div class="text-center mt-12">
        <a href={getLocalePath(lang, '/tutorials/')} class="inline-block bg-gradient-to-r from-primary to-secondary text-white px-8 py-3 rounded-full font-medium hover:shadow-lg hover:shadow-primary/20 transition-all">{t(lang, 'blog.viewMore')}</a>
      </div>
    </div>
  </section>

  <!-- Contact / Footer -->
  <section id="contact" class="py-20 md:py-32">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-xl overflow-hidden">
        <div class="grid grid-cols-1 lg:grid-cols-2">
          <div class="p-10">
            <h3 class="text-2xl font-bold mb-6">{t(lang, 'contact.heading')}</h3>
            <p class="text-gray-600 mb-6">{t(lang, 'contact.description')}</p>
            <a href="https://work.weixin.qq.com/ca/cawcde0b98ca073c6d" class="inline-flex items-center bg-gradient-to-r from-primary to-secondary text-white px-6 py-3 rounded-full font-medium">{t(lang, 'contact.cta')}</a>
          </div>
          <div class="bg-gradient-to-br from-primary/10 to-secondary/10 p-10">
            <h4 class="font-semibold mb-4">{t(lang, 'contact.infoHeading')}</h4>
            <p class="text-gray-600">{t(lang, 'contact.infoText')}</p>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Footer -->
  <footer class="bg-dark text-white pt-16 pb-8">
    <div class="container mx-auto px-4 sm:px-6 lg:px-8">
      <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-8 mb-12">
        <div>
          <a href={getLocalePath(lang, '/')} class="flex items-center space-x-2 mb-6">
            <div class="w-10 h-10 rounded-lg bg-gradient-to-r from-primary to-secondary flex items-center justify-center">
              <img src="https://float.intplusplus.cn/code2art/favicon.jpg" alt={t(lang, 'footer.brand') as string} class="w-10 h-10 rounded-lg" />
            </div>
            <span class="text-xl font-bold">{t(lang, 'footer.brand')}</span>
          </a>
          <p class="text-gray-400 mb-6">{t(lang, 'footer.slogan')}</p>
        </div>

        <div>
          <ul class="space-y-3">
            <li><a href="https://mp.weixin.qq.com/s/LIi41bbEyDAqXZmGm_dGrw"
               class="text-gray-400 hover:text-white transition-colors">ÂÖ¨‰ºóÂè∑</a></li>
            <li><a href="https://www.xiaohongshu.com/user/profile/5ea438e00000000001009548"
               class="text-gray-400 hover:text-white transition-colors">Â∞èÁ∫¢‰π¶</a></li>
            <li><a href="https://space.bilibili.com/309452713"
               class="text-gray-400 hover:text-white transition-colors">BÁ´ô</a></li>
            <li><a href="https://www.douyin.com/user/MS4wLjABAAAA1zXSsULbkb020lMmhP-kt4toB7wgXv18hpcJA2g96gK6aZb0LNYY4VvH-xezjW9j"
               class="text-gray-400 hover:text-white transition-colors">ÊäñÈü≥</a></li>
          </ul>
        </div>

        <div>
          <ul class="space-y-3">
            <li><a href="https://appn6hiNebL8858.h5.xiaoeknow.com"
              class="text-gray-400 hover:text-white transition-colors">Â∞èÈπÖÈÄöËØæÁ®ã</a></li>
            <li><a href="https://github.com/code-2-art"
               class="text-gray-400 hover:text-white transition-colors">Github</a></li>
            <li><a href="https://avantcontra.gumroad.com/"
               class="text-gray-400 hover:text-white transition-colors">Gumroad</a></li>
            <li><a href="https://youtube.com/avantcontra"
               class="text-gray-400 hover:text-white transition-colors">YouTube</a></li>
          </ul>
        </div>
      </div>

      <div class="border-t border-white/10 pt-8 flex flex-col md:flex-row justify-between items-center">
        <p class="text-gray-500 text-sm mb-4 md:mb-0">¬© 2016-{new Date().getFullYear()} {t(lang, 'footer.copyright')}</p>
      </div>
    </div>
  </footer>

  <!-- Back to top -->
  <button id="back-to-top" class="fixed bottom-8 right-8 bg-primary text-white w-11 h-11 rounded-full flex items-center justify-center shadow-lg opacity-0 invisible transition-all z-50" aria-label={t(lang, 'footer.backToTop') as string}>
    <i class="fa fa-arrow-up"></i>
  </button>

  <script is:client>
    const backToTop = document.getElementById('back-to-top');
    function onScrollFooter(){
      if (window.scrollY > 300) {
        backToTop?.classList.remove('opacity-0','invisible');
        backToTop?.classList.add('opacity-100','visible');
      } else {
        backToTop?.classList.add('opacity-0','invisible');
        backToTop?.classList.remove('opacity-100','visible');
      }
    }
    window.addEventListener('scroll', onScrollFooter);
    onScrollFooter();

    backToTop?.addEventListener('click', () => {
      window.scrollTo({ top: 0, behavior: 'smooth' });
    });

    const form = document.querySelector('footer form');
    form?.addEventListener('submit', () => {
      const input = form.querySelector('input[type="email"]');
      if (input && input.value) alert('Â∑≤ËÆ∞ÂΩïËÆ¢ÈòÖÈÇÆÁÆ±Ôºö' + input.value);
    });
  </script>

  <style>
    .text-gradient { background-clip: text; -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .animate-float { animation: float 6s ease-in-out infinite; }
    @keyframes float { 0% { transform: translateY(0); } 50% { transform: translateY(-20px); } 100% { transform: translateY(0); } }
  </style>
</BaseLayout>
